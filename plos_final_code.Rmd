---
output:
  html_document:
    keep_md: true
---

# Load the required Libraries

```{r}
library(sf)
library(dplyr)
library(readr)
library(ggplot2)
```

# 1. File paths 

```{r}
ped_path <- "V:/canadian_pedestrian_network/Saskatoon_ped_1.shp"
da_path  <- "V:/CanALE/Data/DA/DA_2021/lda_000b21a_e.shp"
out_csv  <- "V:/canadian_pedestrian_network/sk_da_plos_score.csv"
```

# 2.  Read layers 

```{r}
ped <- st_read(ped_path, quiet = TRUE)
da_poly <- st_read(da_path, quiet = TRUE) |>
  select(DAUID, PRUID, geometry) |>
  filter(PRUID == "47")  # keep Saskatchewan only
```

  
# 3.  Set Coordinate System

```{r}
ped   <- st_transform(ped, crs = st_crs(da_poly))
```

# 4.  Clean data 

```{r}
ped <- ped |>
  mutate(
    Walk_Width = ifelse(Walk_Width %in% c("99999", 99999, "<Null>"), NA, Walk_Width) |> as.numeric(),
    Walk_Mater = ifelse(Walk_Mater %in% c("<Null>", "0", 0, "9", 9), NA, Walk_Mater) |> as.integer()
  )
```


# 5.  Scoring functions 

```{r}
score_type <- function(x){
  case_when(
    x == "Walkway"  ~ 3,
    x == "Separate" ~ 3,
    x == "Pathway"  ~ 2,
    x == "Combined" ~ 1,
    TRUE            ~ 1
  )
}
```

```{r}

score_width <- function(w){
  case_when(
    is.na(w)  ~ 0,
    w <  1    ~ 0,
    w <  1.5  ~ 1,
    w <  2.5  ~ 2,
    w <  3    ~ 3,
    TRUE      ~ 4
  )
}
```

```{r}
score_material <- function(c){
  case_when(
    c %in% c(1, 2, 10) ~ 3,            # Concrete / Asphalt / Overlay
    c %in% c(3, 4)     ~ 2,            # Brick / Pavers
    c %in% c(5, 7)     ~ 1,            # Crusher Dust / Shale
    c == 6 | is.na(c)  ~ 0,            # Dirt or missing
    TRUE               ~ 0
  )
}
```


# 6.  Segment-level PLOS, normalised by DA area 

```{r}
ped_scored <- ped |>
  mutate(
    sc_type  = score_type(Walk_Type_),           
    sc_width = score_width(Walk_Width),
    sc_mat   = score_material(Walk_Mater),
    q_score  = sc_type + sc_width + sc_mat,      
    seg_km   = SHAPE_Leng / 1000,                
    wtd_val  = q_score * seg_km,
    density  = wtd_val / (LANDAREA)        
  )
```


# 7.  Aggregate density by DAUID 

```{r}
da_scores <- ped_scored |>
  st_drop_geometry() |>
  group_by(DAUID) |>
  summarise(plos_density = sum(density, na.rm = TRUE), .groups = "drop")
```

# 8.  Thresholds for 4 classes (Low / Med / High / Very High) 

```{r}
breaks <- c(-Inf, 80, 160, 240, Inf) 
labels <- c("Low", "Medium", "High", "Very High")
da_scores <- da_scores |>
  mutate(plos_class = cut(plos_density, breaks, labels, include.lowest = TRUE))
write_csv(da_scores, out_csv)
```


# 9.  Crop DA polygons to Saskatoon 

```{r}
bbox_sask <- st_bbox(ped)
buf_m <- 4000                          
bbox_sask <- bbox_sask + c(-buf_m, -buf_m, buf_m, buf_m)
bbox_sask_sf <- st_as_sfc(bbox_sask, crs = st_crs(da_poly))
da_map <- da_poly |>
  st_crop(bbox_sask_sf) |>
  left_join(da_scores, by = "DAUID")
```

  
# 10.  Color selection 

```{r}
plos_colors <- c("Low" = "yellow", "Medium" = "orange",
                 "High" = "red", "Very High" = "darkred")
```


# 11.  Export map  

```{r}
city_label <- "Saskatoon"
p_class <- ggplot() +
  # Optional: roads underlay
  # geom_sf(data = roads, colour = "black", size = 0.3, inherit.aes = FALSE) +
  geom_sf(data = da_map, aes(fill = plos_class), colour = "black", size = 0.05) +
  scale_fill_manual(values = plos_colors, drop = FALSE,
                    name = "PLOS Class",
                    labels = c("Low", "Medium", "High", "Very High")) +
  coord_sf(xlim = c(bbox_sask["xmin"], bbox_sask["xmax"]),
           ylim = c(bbox_sask["ymin"], bbox_sask["ymax"]), expand = FALSE) +
  theme_void() +
  labs(
    title    = sprintf("Pedestrian Level of Service (PLOS) – %s", city_label),
    subtitle = "Low (<80) • Medium (80–160) • High (160–240) • Very High (>240)  [points / km²]",
    caption  = "Data: Pedestrian Network (City / StatsCan, 2025) & 2021 Dissemination Areas"
  ) +
  theme(
    plot.title       = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle    = element_text(size = 12, hjust = 0.5, margin = margin(b = 5)),
    legend.position  = "bottom",
    legend.title     = element_text(size = 12),
    legend.text      = element_text(size = 10),
    legend.key.width = unit(2, "cm")
  )
print(p_class)
ggsave("V:/canadian_pedestrian_network/PLOS_Saskatoon_classes.png",
       plot = p_class, width = 8, height = 6, dpi = 300)
```

       
       
# 12.  Continuous density map 

```{r}
p_cont <- ggplot(da_map) +
  geom_sf(aes(fill = plos_density), colour = NA) +
  scale_fill_viridis_c(option = "plasma", direction = -1,
                       na.value = "grey90", name = "PLOS density\n(points / km²)") +
  coord_sf(xlim = c(bbox_sask["xmin"], bbox_sask["xmax"]),
           ylim = c(bbox_sask["ymin"], bbox_sask["ymax"]), expand = FALSE) +
  theme_void() +
  labs(title = "Continuous PLOS density – Saskatoon")
print(p_cont)
ggsave("V:/canadian_pedestrian_network/PLOS_Saskatoon_continuous.png",
       plot = p_cont, width = 8, height = 6, dpi = 300)
# Creating other plots
```


# 13.  Distribution plots  

## 13A – Histogram of PLOS density

```{r}
ggplot(da_scores, aes(plos_density)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  theme_minimal() +
  labs(
    title = "Distribution of PLOS Density (points / km²)",
    x     = "PLOS Density",
    y     = "Number of DAs"
  )
```

## 13B – Bar plot of PLOS classes

```{r}
ggplot(da_scores, aes(x = plos_class, fill = plos_class)) +
  geom_bar(show.legend = FALSE) +
  scale_fill_manual(values = plos_colors) +
  theme_minimal() +
  labs(
    title = "Count of DAs by PLOS Class — Saskatoon",
    x     = "PLOS Class",
    y     = "Count"
  )
```

